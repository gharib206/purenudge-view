<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pure Nudge</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: 20px; 
        }
        h2 { margin-top: 0; color: var(--tg-theme-hint-color, #888); font-size: 1.2rem; text-align: center;}
        .rtl { direction: rtl; }
        .card {
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 12px;
            padding: 15px;
            width: 100%;
            max-width: 350px;
            box-sizing: border-box;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 0.9rem; }
        input[type="text"], input[type="number"], select {
            width: 100%; padding: 12px; border-radius: 8px;
            border: 1px solid var(--tg-theme-hint-color, #ccc);
            background-color: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-text-color, #000);
            box-sizing: border-box; font-size: 1rem; margin-bottom: 5px; outline: none;
        }
        input:focus, select:focus { border-color: var(--tg-theme-button-color, #3390ec); }
        .radio-group {
            display: flex; justify-content: space-around; margin-bottom: 15px;
            background: var(--tg-theme-bg-color); padding: 5px; border-radius: 8px;
        }
        .radio-option { display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .hint { font-size: 0.8rem; color: var(--tg-theme-hint-color, #999); margin-top: -5px; margin-bottom: 15px; }
        
        /* ÿßÿ≥ÿ™ÿß€åŸÑ ÿØ⁄©ŸÖŸá‚ÄåŸáÿß€å ŸÜŸàÿπ ÿ±Ÿà€åÿØÿßÿØ (⁄Ü€åŸæ) */
        .type-selector { display: flex; gap: 10px; margin-bottom: 10px; }
        .type-chip {
            flex: 1; text-align: center; padding: 10px;
            background: var(--tg-theme-bg-color); border: 1px solid var(--tg-theme-hint-color);
            border-radius: 8px; cursor: pointer; transition: 0.2s;
        }
        .type-chip.active {
            background-color: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #fff);
            border-color: var(--tg-theme-button-color, #3390ec);
        }
        input[type="radio"].hidden { display: none; }
    </style>
</head>
<body>

    <h2 id="lbl_title">Add Event</h2>

    <div class="card">
        <label id="lbl_type">Event Type:</label>
        <div class="type-selector">
            <label class="type-chip active" id="chip_birthday">
                <input type="radio" name="event_type" value="birthday" checked class="hidden" onchange="updateTypeUI()">
                <span id="txt_birthday">Birthday üéÇ</span>
            </label>
            <label class="type-chip" id="chip_anniversary">
                <input type="radio" name="event_type" value="anniversary" class="hidden" onchange="updateTypeUI()">
                <span id="txt_anniversary">Anniversary üíç</span>
            </label>
        </div>
    </div>

    <div class="card">
        <label id="lbl_name">Name / Title:</label>
        <input type="text" id="name" placeholder="..." />
    </div>

    <div class="card">
        <label id="lbl_calendar">Calendar Type:</label>
        <div class="radio-group">
            <label class="radio-option">
                <input type="radio" name="calendar" value="gregorian" checked onchange="handleCalendarChange()">
                <span id="lbl_gregorian">Gregorian</span>
            </label>
            <label class="radio-option">
                <input type="radio" name="calendar" value="shamsi" onchange="handleCalendarChange()">
                <span id="lbl_shamsi">Shamsi</span>
            </label>
        </div>

        <div style="display: flex; gap: 10px;">
            <div style="flex: 1;">
                <label id="lbl_day">Day</label>
                <select id="day"></select>
            </div>
            <div style="flex: 2;">
                <label id="lbl_month">Month</label>
                <select id="month"></select>
            </div>
        </div>
        
        <div style="margin-top: 10px;">
            <label id="lbl_year">Year (Optional):</label>
            <input type="number" id="year" placeholder="2024" min="1300" max="2100" inputmode="numeric">
        </div>
    </div>

    <div class="card">
        <label id="lbl_notify">Remind me:</label>
        <select id="notify">
            <option value="0" id="opt_0">On the exact day</option>
            <option value="1" id="opt_1">1 day before</option>
            <option value="3" id="opt_3">3 days before</option>
            <option value="7" id="opt_7">1 week before</option>
        </select>
        <p class="hint" id="lbl_time_hint">We will notify you at 9:00 AM.</p>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const TEXTS = {
            en: { title: "Add Event", type: "Event Type:", birthday: "Birthday üéÇ", anniversary: "Anniversary üíç", name: "Name / Title:", calendar: "Calendar:", shamsi: "Shamsi", gregorian: "Gregorian", day: "Day", month: "Month", year: "Year (Optional)", notify: "Remind:", opt0: "Same day", opt1: "1 day before", opt3: "3 days before", opt7: "1 week before", hint: "Time: 9:00 AM", save: "Save Event", error: "Please enter a name!" },
            fa: { title: "ÿßŸÅÿ≤ŸàÿØŸÜ ÿ±Ÿà€åÿØÿßÿØ", type: "ŸÜŸàÿπ ÿ±Ÿà€åÿØÿßÿØ:", birthday: "ÿ™ŸàŸÑÿØ üéÇ", anniversary: "ÿ≥ÿßŸÑ⁄Øÿ±ÿØ üíç", name: "ŸÜÿßŸÖ / ÿπŸÜŸàÿßŸÜ:", calendar: "ÿ™ŸÇŸà€åŸÖ:", shamsi: "ÿ¥ŸÖÿ≥€å", gregorian: "ŸÖ€åŸÑÿßÿØ€å", day: "ÿ±Ÿàÿ≤", month: "ŸÖÿßŸá", year: "ÿ≥ÿßŸÑ (ÿßÿÆÿ™€åÿßÿ±€å)", notify: "€åÿßÿØÿ¢Ÿàÿ±€å:", opt0: "ŸáŸÖÿßŸÜ ÿ±Ÿàÿ≤", opt1: "€± ÿ±Ÿàÿ≤ ŸÇÿ®ŸÑ", opt3: "€≥ ÿ±Ÿàÿ≤ ŸÇÿ®ŸÑ", opt7: "€± ŸáŸÅÿ™Ÿá ŸÇÿ®ŸÑ", hint: "ÿ≥ÿßÿπÿ™: €π ÿµÿ®ÿ≠", save: "ÿ∞ÿÆ€åÿ±Ÿá ÿ±Ÿà€åÿØÿßÿØ", error: "ŸÑÿ∑ŸÅÿßŸã ŸÜÿßŸÖ ÿ±ÿß Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ!" },
            ar: { title: "ÿ•ÿ∂ÿßŸÅÿ© ÿ≠ÿØÿ´", type: "ŸÜŸàÿπ ÿßŸÑÿ≠ÿØÿ´:", birthday: "ÿπŸäÿØ ŸÖŸäŸÑÿßÿØ üéÇ", anniversary: "ÿ∞ŸÉÿ±Ÿâ ÿ≥ŸÜŸàŸäÿ© üíç", name: "ÿßŸÑÿßÿ≥ŸÖ / ÿßŸÑÿπŸÜŸàÿßŸÜ:", calendar: "ÿßŸÑÿ™ŸÇŸàŸäŸÖ:", shamsi: "ÿ¥ŸÖÿ≥Ÿä", gregorian: "ŸÖŸäŸÑÿßÿØŸä", day: "ŸäŸàŸÖ", month: "ÿ¥Ÿáÿ±", year: "ÿ≥ŸÜÿ©", notify: "ÿ™ÿ∞ŸÉŸäÿ±:", opt0: "ŸÜŸÅÿ≥ ÿßŸÑŸäŸàŸÖ", opt1: "ŸÇÿ®ŸÑ ŸäŸàŸÖ", opt3: "ŸÇÿ®ŸÑ 3 ÿ£ŸäÿßŸÖ", opt7: "ŸÇÿ®ŸÑ ÿ£ÿ≥ÿ®Ÿàÿπ", hint: "ÿ≥ÿßÿπÿ©: 9 ÿµ", save: "ÿ≠ŸÅÿ∏", error: "ÿ£ÿØÿÆŸÑ ÿßŸÑÿßÿ≥ŸÖ!" },
            ru: { title: "–î–æ–±–∞–≤–∏—Ç—å", type: "–¢–∏–ø —Å–æ–±—ã—Ç–∏—è:", birthday: "–î–† üéÇ", anniversary: "–ì–æ–¥–æ–≤—â–∏–Ω–∞ üíç", name: "–ò–º—è / –ù–∞–∑–≤–∞–Ω–∏–µ:", calendar: "–ö–∞–ª–µ–Ω–¥–∞—Ä—å:", shamsi: "–®–∞–º—Å–∏", gregorian: "–ì—Ä–∏–≥–æ—Ä–∏–∞–Ω—Å–∫–∏–π", day: "–î–µ–Ω—å", month: "–ú–µ—Å—è—Ü", year: "–ì–æ–¥", notify: "–ù–∞–ø–æ–º–Ω–∏—Ç—å:", opt0: "–í —Ç–æ—Ç –∂–µ –¥–µ–Ω—å", opt1: "–ó–∞ 1 –¥–µ–Ω—å", opt3: "–ó–∞ 3 –¥–Ω—è", opt7: "–ó–∞ –Ω–µ–¥–µ–ª—é", hint: "–í—Ä–µ–º—è: 9:00", save: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å", error: "–í–≤–µ–¥–∏—Ç–µ –∏–º—è!" }
        };

        const urlParams = new URLSearchParams(window.location.search);
        const userLang = urlParams.get('lang') || 'en';
        const t = TEXTS[userLang] || TEXTS['en'];

        function applyLanguage() {
            document.getElementById('lbl_title').innerText = t.title;
            document.getElementById('lbl_type').innerText = t.type;
            document.getElementById('txt_birthday').innerText = t.birthday;
            document.getElementById('txt_anniversary').innerText = t.anniversary;
            document.getElementById('lbl_name').innerText = t.name;
            document.getElementById('lbl_calendar').innerText = t.calendar;
            document.getElementById('lbl_shamsi').innerText = t.shamsi;
            document.getElementById('lbl_gregorian').innerText = t.gregorian;
            document.getElementById('lbl_day').innerText = t.day;
            document.getElementById('lbl_month').innerText = t.month;
            document.getElementById('lbl_year').innerText = t.year;
            document.getElementById('lbl_notify').innerText = t.notify;
            document.getElementById('opt_0').innerText = t.opt0;
            document.getElementById('opt_1').innerText = t.opt1;
            document.getElementById('opt_3').innerText = t.opt3;
            document.getElementById('opt_7').innerText = t.opt7;
            document.getElementById('lbl_time_hint').innerText = t.hint;

            if (userLang === 'fa' || userLang === 'ar') {
                document.body.classList.add('rtl');
                document.querySelectorAll('input, select').forEach(el => el.style.textAlign = 'right');
            }
            tg.MainButton.setText(t.save);
            tg.MainButton.show();
        }

        function updateTypeUI() {
            // ÿ™ÿ∫€å€åÿ± ÿßÿ≥ÿ™ÿß€åŸÑ ÿØ⁄©ŸÖŸá‚ÄåŸáÿß€å ÿßŸÜÿ™ÿÆÿßÿ® ŸÜŸàÿπ
            document.querySelectorAll('.type-chip').forEach(el => el.classList.remove('active'));
            const selected = document.querySelector('input[name="event_type"]:checked');
            selected.parentElement.classList.add('active');
        }

        // --- ÿ™ŸÇŸà€åŸÖ Ÿà ÿ≥ÿß€åÿ± ⁄©ÿØŸáÿß ---
        const monthSelect = document.getElementById("month");
        const daySelect = document.getElementById("day");
        const monthsShamsi = ["ŸÅÿ±Ÿàÿ±ÿØ€åŸÜ", "ÿßÿ±ÿØ€åÿ®Ÿáÿ¥ÿ™", "ÿÆÿ±ÿØÿßÿØ", "ÿ™€åÿ±", "ŸÖÿ±ÿØÿßÿØ", "ÿ¥Ÿáÿ±€åŸàÿ±", "ŸÖŸáÿ±", "ÿ¢ÿ®ÿßŸÜ", "ÿ¢ÿ∞ÿ±", "ÿØ€å", "ÿ®ŸáŸÖŸÜ", "ÿßÿ≥ŸÅŸÜÿØ"];
        const monthsGregorian = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

        function handleCalendarChange() {
            const isShamsi = document.querySelector('input[name="calendar"]:checked').value === 'shamsi';
            const yearInput = document.getElementById('year');
            if (isShamsi) {
                yearInput.placeholder = "13xx";
                updateDropdowns(monthsShamsi);
            } else {
                yearInput.placeholder = "20xx";
                updateDropdowns(monthsGregorian);
            }
        }

        function updateDropdowns(monthsList) {
            const currentMonthIdx = monthSelect.selectedIndex >= 0 ? monthSelect.selectedIndex : 0;
            monthSelect.innerHTML = "";
            monthsList.forEach((m, index) => {
                let option = document.createElement("option");
                option.value = index + 1;
                option.text = m;
                monthSelect.appendChild(option);
            });
            monthSelect.selectedIndex = currentMonthIdx;
            updateDays();
        }

        function updateDays() {
            const isShamsi = document.querySelector('input[name="calendar"]:checked').value === 'shamsi';
            const selectedMonth = parseInt(monthSelect.value);
            let maxDays = 31;
            if (isShamsi) {
                if (selectedMonth > 6 && selectedMonth < 12) maxDays = 30;
                if (selectedMonth === 12) maxDays = 29; 
            } else {
                if ([4, 6, 9, 11].includes(selectedMonth)) maxDays = 30;
                if (selectedMonth === 2) maxDays = 29;
            }
            const currentDay = daySelect.value;
            daySelect.innerHTML = "";
            for (let i = 1; i <= maxDays; i++) {
                let option = document.createElement("option");
                option.value = i;
                option.text = i;
                daySelect.appendChild(option);
            }
            if (currentDay && currentDay <= maxDays) daySelect.value = currentDay;
        }

        monthSelect.addEventListener("change", updateDays);

        function saveData() {
            const name = document.getElementById("name").value;
            const yearVal = document.getElementById("year").value;
            
            if (!name || name.trim() === "") {
                tg.showPopup({title: 'Error', message: t.error});
                return;
            }
            tg.MainButton.showProgress(true);

            const data = {
                event_type: document.querySelector('input[name="event_type"]:checked').value, // ÿØÿßÿØŸá ÿ¨ÿØ€åÿØ
                name: name,
                calendar: document.querySelector('input[name="calendar"]:checked').value,
                day: parseInt(daySelect.value),
                month: parseInt(monthSelect.value),
                year: yearVal ? parseInt(yearVal) : null,
                notify: parseInt(document.getElementById("notify").value)
            };
            tg.sendData(JSON.stringify(data));
        }

        Telegram.WebApp.onEvent('mainButtonClicked', saveData);

        applyLanguage();
        handleCalendarChange(); 
    </script>
</body>
</html>
