<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pure Nudge</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h2 { margin-top: 0; color: var(--tg-theme-hint-color, #888); font-size: 1.2rem; text-align: center;}
        
        /* جهت راست‌چین برای فارسی و عربی */
        .rtl { direction: rtl; }

        .card {
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 12px;
            padding: 15px;
            width: 100%;
            max-width: 350px;
            box-sizing: border-box;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 0.9rem; }
        
        input[type="text"], input[type="number"], select {
            width: 100%; padding: 12px; border-radius: 8px;
            border: 1px solid var(--tg-theme-hint-color, #ccc);
            background-color: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-text-color, #000);
            box-sizing: border-box; font-size: 1rem; margin-bottom: 5px; outline: none;
        }

        input:focus, select:focus { border-color: var(--tg-theme-button-color, #3390ec); }

        .radio-group {
            display: flex; justify-content: space-around; margin-bottom: 15px;
            background: var(--tg-theme-bg-color); padding: 5px; border-radius: 8px;
        }
        .radio-option { display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .hint { font-size: 0.8rem; color: var(--tg-theme-hint-color, #999); margin-top: -5px; margin-bottom: 15px; }
    </style>
</head>
<body>

    <h2 id="lbl_title">Add Birthday</h2>

    <div class="card">
        <label id="lbl_name">Name:</label>
        <input type="text" id="name" />
    </div>

    <div class="card">
        <label id="lbl_calendar">Calendar Type:</label>
        <div class="radio-group">
            <label class="radio-option">
                <input type="radio" name="calendar" value="gregorian" checked onchange="handleCalendarChange()">
                <span id="lbl_gregorian">Gregorian</span>
            </label>
            <label class="radio-option">
                <input type="radio" name="calendar" value="shamsi" onchange="handleCalendarChange()">
                <span id="lbl_shamsi">Shamsi</span>
            </label>
        </div>

        <div style="display: flex; gap: 10px;">
            <div style="flex: 1;">
                <label id="lbl_day">Day</label>
                <select id="day"></select>
            </div>
            <div style="flex: 2;">
                <label id="lbl_month">Month</label>
                <select id="month"></select>
            </div>
        </div>
        
        <div style="margin-top: 10px;">
            <label id="lbl_year">Year (Optional):</label>
            <input type="number" id="year" placeholder="2024" min="1300" max="2100" inputmode="numeric">
        </div>
    </div>

    <div class="card">
        <label id="lbl_notify">Remind me:</label>
        <select id="notify">
            <option value="0" id="opt_0">On the exact day</option>
            <option value="1" id="opt_1">1 day before</option>
            <option value="3" id="opt_3">3 days before</option>
            <option value="7" id="opt_7">1 week before</option>
        </select>
        <p class="hint" id="lbl_time_hint">We will notify you at 9:00 AM.</p>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // --- دیکشنری زبان‌ها ---
        const TEXTS = {
            en: {
                title: "Add Birthday",
                name: "Name of person:",
                calendar: "Calendar Type:",
                shamsi: "Shamsi (Jalali)",
                gregorian: "Gregorian",
                day: "Day",
                month: "Month",
                year: "Year (Optional)",
                notify: "Remind me:",
                opt0: "On the exact day",
                opt1: "1 day before",
                opt3: "3 days before",
                opt7: "1 week before",
                hint: "Notification time: 9:00 AM",
                save: "Save Birthday",
                error: "Please enter a name."
            },
            fa: {
                title: "افزودن تولد",
                name: "نام شخص:",
                calendar: "نوع تقویم:",
                shamsi: "شمسی",
                gregorian: "میلادی",
                day: "روز",
                month: "ماه",
                year: "سال (اختیاری)",
                notify: "زمان یادآوری:",
                opt0: "همان روز",
                opt1: "۱ روز قبل",
                opt3: "۳ روز قبل",
                opt7: "۱ هفته قبل",
                hint: "ساعت ارسال پیام: ۹ صبح",
                save: "ذخیره تولد",
                error: "لطفاً نام را وارد کنید."
            },
            ar: {
                title: "إضافة عيد ميلاد",
                name: "الاسم:",
                calendar: "نوع التقويم:",
                shamsi: "شمسي (هجري شمسي)",
                gregorian: "ميلادي",
                day: "اليوم",
                month: "الشهر",
                year: "السنة (اختياري)",
                notify: "تذكير:",
                opt0: "في نفس اليوم",
                opt1: "قبل يوم واحد",
                opt3: "قبل 3 أيام",
                opt7: "قبل أسبوع",
                hint: "وقت التنبيه: 9:00 صباحاً",
                save: "حفظ",
                error: "الرجاء إدخال الاسم."
            },
            ru: {
                title: "Добавить ДР",
                name: "Имя:",
                calendar: "Календарь:",
                shamsi: "Шамси (Иранский)",
                gregorian: "Григорианский",
                day: "День",
                month: "Месяц",
                year: "Год (необязательно)",
                notify: "Напомнить:",
                opt0: "В тот же день",
                opt1: "За 1 день",
                opt3: "За 3 дня",
                opt7: "За неделю",
                hint: "Время уведомления: 9:00",
                save: "Сохранить",
                error: "Пожалуйста, введите имя."
            }
        };

        const urlParams = new URLSearchParams(window.location.search);
        const userLang = urlParams.get('lang') || 'en';
        const t = TEXTS[userLang] || TEXTS['en'];

        function applyLanguage() {
            document.getElementById('lbl_title').innerText = t.title;
            document.getElementById('lbl_name').innerText = t.name;
            document.getElementById('lbl_calendar').innerText = t.calendar;
            document.getElementById('lbl_shamsi').innerText = t.shamsi;
            document.getElementById('lbl_gregorian').innerText = t.gregorian;
            document.getElementById('lbl_day').innerText = t.day;
            document.getElementById('lbl_month').innerText = t.month;
            document.getElementById('lbl_year').innerText = t.year;
            document.getElementById('lbl_notify').innerText = t.notify;
            document.getElementById('opt_0').innerText = t.opt0;
            document.getElementById('opt_1').innerText = t.opt1;
            document.getElementById('opt_3').innerText = t.opt3;
            document.getElementById('opt_7').innerText = t.opt7;
            document.getElementById('lbl_time_hint').innerText = t.hint;

            if (userLang === 'fa' || userLang === 'ar') {
                document.body.classList.add('rtl');
                document.querySelectorAll('input, select').forEach(el => el.style.textAlign = 'right');
            }

            tg.MainButton.setText(t.save);
            tg.MainButton.show();
        }

        const monthSelect = document.getElementById("month");
        const daySelect = document.getElementById("day");
        
        const monthsShamsi = ["فروردین", "اردیبهشت", "خرداد", "تیر", "مرداد", "شهریور", "مهر", "آبان", "آذر", "دی", "بهمن", "اسفند"];
        const monthsGregorian = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

        function handleCalendarChange() {
            const isShamsi = document.querySelector('input[name="calendar"]:checked').value === 'shamsi';
            const yearInput = document.getElementById('year');
            
            if (isShamsi) {
                yearInput.placeholder = "13xx";
                updateDropdowns(monthsShamsi);
            } else {
                yearInput.placeholder = "20xx";
                updateDropdowns(monthsGregorian);
            }
        }

        function updateDropdowns(monthsList) {
            const currentMonthIdx = monthSelect.selectedIndex >= 0 ? monthSelect.selectedIndex : 0;
            const currentDay = daySelect.value;

            monthSelect.innerHTML = "";
            monthsList.forEach((m, index) => {
                let option = document.createElement("option");
                option.value = index + 1;
                option.text = m;
                monthSelect.appendChild(option);
            });
            monthSelect.selectedIndex = currentMonthIdx;

            updateDays();
        }

        function updateDays() {
            const isShamsi = document.querySelector('input[name="calendar"]:checked').value === 'shamsi';
            const selectedMonth = parseInt(monthSelect.value);
            let maxDays = 31;

            if (isShamsi) {
                if (selectedMonth > 6 && selectedMonth < 12) maxDays = 30;
                if (selectedMonth === 12) maxDays = 29; 
            } else {
                if ([4, 6, 9, 11].includes(selectedMonth)) maxDays = 30;
                if (selectedMonth === 2) maxDays = 29;
            }

            const currentDay = daySelect.value;
            daySelect.innerHTML = "";
            for (let i = 1; i <= maxDays; i++) {
                let option = document.createElement("option");
                option.value = i;
                option.text = i;
                daySelect.appendChild(option);
            }
            if (currentDay && currentDay <= maxDays) daySelect.value = currentDay;
        }

        monthSelect.addEventListener("change", updateDays);

        Telegram.WebApp.onEvent('mainButtonClicked', function(){
            const name = document.getElementById("name").value;
            const yearVal = document.getElementById("year").value;
            
            if (!name) {
                tg.showPopup({title: "Error", message: t.error});
                return;
            }

            const data = {
                name: name,
                calendar: document.querySelector('input[name="calendar"]:checked').value,
                day: parseInt(daySelect.value),
                month: parseInt(monthSelect.value),
                year: yearVal ? parseInt(yearVal) : null,
                notify: parseInt(document.getElementById("notify").value)
            };

            tg.sendData(JSON.stringify(data));
        });

        applyLanguage();
        handleCalendarChange(); 

    </script>
</body>
</html>